<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign the Guestbook</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header style="text-align: center; margin-bottom: 2rem;">
      <h1>Sign Our Guestbook</h1>
      <p class="subtitle">Leave us a message and share in our special day</p>
    </header>

    <div id="message-container"></div>

    <form id="guestbook-form" class="guestbook-form">
      <div class="form-group">
        <label for="name">Your Name</label>
        <input 
          type="text" 
          id="name" 
          name="name" 
          maxlength="120" 
          placeholder="Enter your name"
          required
        >
        <div class="char-count"><span id="name-count">0</span>/120</div>
      </div>

      <div class="form-group">
        <label for="note">Your Message</label>
        <textarea 
          id="note" 
          name="note" 
          placeholder="Write your wishes, memories, or advice for the happy couple..."
          required
        ></textarea>
      </div>

      <div class="form-group checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" id="private-message" name="private">
          <span class="checkbox-text">Keep this message private (only visible to the couple)</span>
        </label>
      </div>

      <div class="form-group">
        <span class="form-label">Photos (Optional - up to 5)</span>
        
        <!-- Selected photos thumbnails -->
        <div id="photo-thumbnails" class="photo-thumbnails"></div>
        
        <div class="photo-capture-wrapper" id="photo-capture-wrapper">
          <!-- Webcam capture area -->
          <div id="webcam-container" style="display: none;">
            <video id="webcam-video" autoplay playsinline></video>
            <div class="webcam-controls">
              <button type="button" class="btn btn-primary" id="capture-btn">üì∏ Take Photo</button>
              <button type="button" class="btn btn-secondary" id="cancel-webcam-btn">Cancel</button>
            </div>
          </div>
          
          <!-- Add photo buttons -->
          <div id="photo-buttons">
            <button type="button" class="btn btn-secondary" id="start-webcam-btn">
              üì∑ Take a Selfie
            </button>
            <span class="photo-or">or</span>
            <div class="drop-zone" id="drop-zone">
              <div class="drop-zone-text">üìÅ Drag photo here</div>
              <input type="file" id="photos" name="photos" accept="image/*" multiple class="file-input-styled">
            </div>
          </div>
          <canvas id="photo-canvas" style="display: none;"></canvas>
        </div>
        <div class="photo-count" id="photo-count">0/5 photos</div>
      </div>

      <button type="submit" class="btn btn-primary" id="submit-btn">
        Sign the Guestbook
      </button>
    </form>

    <div style="text-align: center; margin-top: 2rem;">
      <a href="/display" class="btn btn-secondary">View All Messages</a>
    </div>
  </div>

  <script>
    const form = document.getElementById('guestbook-form');
    const nameInput = document.getElementById('name');
    const nameCount = document.getElementById('name-count');
    const photosInput = document.getElementById('photos');
    const messageContainer = document.getElementById('message-container');
    const submitBtn = document.getElementById('submit-btn');

    let selectedFiles = [];

    // Character count for name
    nameInput.addEventListener('input', () => {
      nameCount.textContent = nameInput.value.length;
    });

    // Photo capture elements
    const webcamContainer = document.getElementById('webcam-container');
    const webcamVideo = document.getElementById('webcam-video');
    const photoCanvas = document.getElementById('photo-canvas');
    const photoButtons = document.getElementById('photo-buttons');
    const photoThumbnails = document.getElementById('photo-thumbnails');
    const photoCount = document.getElementById('photo-count');
    const startWebcamBtn = document.getElementById('start-webcam-btn');
    const captureBtn = document.getElementById('capture-btn');
    const cancelWebcamBtn = document.getElementById('cancel-webcam-btn');
    
    let mediaStream = null;
    let selectedPhotos = []; // Array to hold {type: 'blob'|'file', data: Blob|File, preview: string}
    const MAX_PHOTOS = 5;

    // Update photo count and toggle buttons
    function updatePhotoUI() {
      photoCount.textContent = `${selectedPhotos.length}/${MAX_PHOTOS} photos`;
      
      // Hide add buttons if we have max photos
      if (selectedPhotos.length >= MAX_PHOTOS) {
        photoButtons.style.display = 'none';
      } else {
        photoButtons.style.display = 'flex';
      }
      
      // Render thumbnails
      photoThumbnails.innerHTML = '';
      selectedPhotos.forEach((photo, index) => {
        const thumbnail = document.createElement('div');
        thumbnail.className = 'photo-thumbnail';
        thumbnail.innerHTML = `
          <img src="${photo.preview}" alt="Photo ${index + 1}">
          <button type="button" class="thumbnail-remove" onclick="removePhoto(${index})">‚úï</button>
        `;
        photoThumbnails.appendChild(thumbnail);
      });
    }

    // Add photo to array
    function addPhoto(data, type = 'file') {
      if (selectedPhotos.length >= MAX_PHOTOS) {
        alert(`Maximum ${MAX_PHOTOS} photos allowed`);
        return;
      }
      
      const preview = type === 'blob' ? URL.createObjectURL(data) : URL.createObjectURL(data);
      selectedPhotos.push({ type, data, preview });
      updatePhotoUI();
    }

    // Remove photo from array
    window.removePhoto = function(index) {
      if (selectedPhotos[index]) {
        URL.revokeObjectURL(selectedPhotos[index].preview);
        selectedPhotos.splice(index, 1);
        updatePhotoUI();
      }
    };

    // Start webcam
    startWebcamBtn.addEventListener('click', async () => {
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
          audio: false 
        });
        webcamVideo.srcObject = mediaStream;
        photoButtons.style.display = 'none';
        webcamContainer.style.display = 'block';
        // Auto-scroll to show the webcam container
        setTimeout(() => {
          webcamContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
      } catch (err) {
        alert('Could not access webcam. Please check permissions or use the upload option.');
        console.error('Webcam error:', err);
      }
    });

    // Spacebar hotkey to capture photo when webcam is active
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && mediaStream && webcamContainer.style.display !== 'none') {
        e.preventDefault();
        captureBtn.click();
      }
    });

    // Capture photo from webcam
    captureBtn.addEventListener('click', () => {
      if (selectedPhotos.length >= MAX_PHOTOS) {
        alert(`Maximum ${MAX_PHOTOS} photos allowed`);
        stopWebcam();
        webcamContainer.style.display = 'none';
        return;
      }
      
      photoCanvas.width = webcamVideo.videoWidth;
      photoCanvas.height = webcamVideo.videoHeight;
      const ctx = photoCanvas.getContext('2d');
      ctx.drawImage(webcamVideo, 0, 0);
      
      photoCanvas.toBlob((blob) => {
        addPhoto(blob, 'blob');
        stopWebcam();
        webcamContainer.style.display = 'none';
      }, 'image/jpeg', 0.85);
    });

    // Cancel webcam
    cancelWebcamBtn.addEventListener('click', () => {
      stopWebcam();
      webcamContainer.style.display = 'none';
    });

    // Drop zone for drag and drop
    const dropZone = document.getElementById('drop-zone');
    
    // Prevent browser from opening dropped files
    document.addEventListener('dragover', (e) => e.preventDefault());
    document.addEventListener('drop', (e) => e.preventDefault());
    
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });
    
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('drag-over');
    });
    
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      handleFiles(e.dataTransfer.files);
    });
    
    // File upload
    photosInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
      // Clear the input so the same file can be selected again
      photosInput.value = '';
    });
    
    function handleFiles(files) {
      const remaining = MAX_PHOTOS - selectedPhotos.length;
      if (remaining === 0) {
        alert(`Maximum ${MAX_PHOTOS} photos already selected`);
        return;
      }
      
      let added = 0;
      for (let i = 0; i < files.length && added < remaining; i++) {
        const file = files[i];
        if (file.type.startsWith('image/')) {
          if (file.size <= 25 * 1024 * 1024) {
            addPhoto(file, 'file');
            added++;
          } else {
            alert(`${file.name} is too large. Maximum size is 25MB.`);
          }
        } else {
          alert(`${file.name} is not an image file.`);
        }
      }
      
      if (added > 0 && files.length > remaining) {
        alert(`Only ${added} photo(s) added. Maximum ${MAX_PHOTOS} total.`);
      }
    }

    function stopWebcam() {
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }
    }

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      
      const formData = new FormData();
      formData.append('name', nameInput.value.trim());
      formData.append('note', document.getElementById('note').value.trim());
      formData.append('private', document.getElementById('private-message').checked);
      
      // Add all selected photos
      selectedPhotos.forEach((photo, index) => {
        if (photo.type === 'blob') {
          formData.append('photos', photo.data, `photo-${index + 1}.jpg`);
        } else {
          formData.append('photos', photo.data);
        }
      });
      
      // Stop webcam if still running
      stopWebcam();
      
      try {
        const response = await fetch('/api/entries', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showMessage('success', data.message);
          form.reset();
          // Clear all photos
          selectedPhotos.forEach(photo => URL.revokeObjectURL(photo.preview));
          selectedPhotos = [];
          updatePhotoUI();
          nameCount.textContent = '0';
        } else {
          showMessage('error', data.error || 'Something went wrong');
        }
      } catch (error) {
        showMessage('error', 'Failed to submit. Please try again.');
      }
      
      submitBtn.disabled = false;
      submitBtn.textContent = 'Sign the Guestbook';
    });

    function showMessage(type, text) {
      messageContainer.innerHTML = `<div class="message message-${type}">${text}</div>`;
      messageContainer.scrollIntoView({ behavior: 'smooth' });
    }
  </script>
</body>
</html>
